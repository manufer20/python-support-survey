<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="color-scheme" content="light">
  <title>Student Satisfaction Survey</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-50 flex min-h-screen overflow-hidden">
  
  <!-- Sidebar -->
  <div id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex items-center justify-between h-16 px-4 border-b">
      <h2 class="text-lg font-semibold text-gray-800">Menu</h2>
      <button id="closeSidebar" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <nav class="mt-8">
      <a href="#" id="surveyTab" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 border-r-4 border-red-500 bg-gray-50">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        Survey
      </a>
      <a href="#" id="analyticsTab" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Analytics
      </a>
    </nav>
  </div>

  <!-- Sidebar overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <!-- Main content -->
  <div class="flex-1 flex flex-col">
    <!-- Header -->
    <header class="h-16 flex items-center px-4">
      <button id="openSidebar" class="text-gray-500 hover:text-gray-700 mr-4">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </header>

    <!-- Building Selection Page -->
    <div id="buildingSelectionPage" class="flex-1 flex items-center justify-center p-4">
      <div class="w-full max-w-lg md:max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-gray-700 text-center">Select Your Building</h2>

        <div class="space-y-4">
          <button 
            onclick="selectBuilding(302)"
            class="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-red-300 hover:bg-red-50 transition-colors text-left"
          >
            <div class="font-semibold text-gray-700">Building 302</div>
            <div class="text-sm text-gray-500">Main Python Support Office</div>
          </button>
          
          <button 
            onclick="selectBuilding(358)"
            class="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-red-300 hover:bg-red-50 transition-colors text-left"
          >
            <div class="font-semibold text-gray-700">Building 358</div>
            <div class="text-sm text-gray-500">Secondary Python Support Office</div>
          </button>
          
          <!-- Custom Building Section -->
          <div class="border-2 border-gray-200 rounded-lg p-4">
            <div class="font-semibold text-gray-700 mb-2">Other Building</div>
            <div class="text-sm text-gray-500 mb-3">Enter building number</div>
            <div class="flex gap-2">
              <input
                id="customBuilding"
                type="number"
                placeholder="e.g. 324"
                min="100"
                max="500"
                class="flex-1 border border-gray-300 p-2 rounded focus:ring-2 focus:ring-red-500 focus:border-red-500"
                onkeypress="handleEnterKey(event)"
              />
              <button
                onclick="selectCustomBuilding()"
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors"
              >
                Select
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Survey Page -->
    <div id="surveyPage" class="flex-1 flex items-center justify-center p-4 hidden">
      <div class="w-full max-w-lg md:max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-gray-700">Student Satisfaction Survey</h2>
        </div>
        

        <form id="surveyForm" class="space-y-6">
          <div>
            <label class="block text-gray-700 mb-2 font-medium" for="student_number">Student Number:</label>
            <div class="flex">
              <span class="inline-flex items-center px-3 text-gray-700 bg-gray-200 border border-r-0 border-gray-300 rounded-l">
                s
              </span>
              <input
                id="student_number"
                name="student_number"
                type="text"
                inputmode="numeric"
                pattern="[0-9]{6}"
                placeholder="e.g. 123456"
                class="flex-1 border border-gray-300 p-3 rounded-r focus:ring-2 focus:ring-red-500 focus:border-red-500"
                required
              />
            </div>
          </div>

          <div>
            <span class="block text-gray-700 mb-3 font-medium">Satisfaction (1 to 5):</span>
            <div class="flex justify-between">
              <label class="flex flex-col items-center text-gray-600 cursor-pointer">
                <input type="radio" name="satisfaction" value="1" class="form-radio mb-2" required />
                <img src="face1.png" alt="Satisfaction level 1" class="w-10 h-10" />
              </label>
              <label class="flex flex-col items-center text-gray-600 cursor-pointer">
                <input type="radio" name="satisfaction" value="2" class="form-radio mb-2" />
                <img src="face2.png" alt="Satisfaction level 2" class="w-10 h-10" />
              </label>
              <label class="flex flex-col items-center text-gray-600 cursor-pointer">
                <input type="radio" name="satisfaction" value="3" class="form-radio mb-2" />
                <img src="face3.png" alt="Satisfaction level 3" class="w-10 h-10" />
              </label>
              <label class="flex flex-col items-center text-gray-600 cursor-pointer">
                <input type="radio" name="satisfaction" value="4" class="form-radio mb-2" />
                <img src="face4.png" alt="Satisfaction level 4" class="w-10 h-10" />
              </label>
              <label class="flex flex-col items-center text-gray-600 cursor-pointer">
                <input type="radio" name="satisfaction" value="5" class="form-radio mb-2" />
                <img src="face5.png" alt="Satisfaction level 5" class="w-10 h-10" />
              </label>
            </div>
          </div>

          <div>
            <label class="block text-gray-700 mb-2 font-medium" for="course_number">Course Number or Name (optional):</label>
            <input
              id="course_number"
              name="course_number"
              list="courses"
              type="text"
              placeholder="e.g. 01003 - Mathematics 1a"
              class="w-full border border-gray-300 p-3 rounded focus:ring-2 focus:ring-red-500 focus:border-red-500"
            />
            <datalist id="courses"></datalist>
          </div>

          <button
            id="submitButton"
            type="submit"
            class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 w-full font-medium transition-colors"
          >
            Submit Survey
          </button>
        </form>
      </div>
    </div>

    <!-- Analytics Page -->
    <div id="analyticsPage" class="flex-1 p-6 hidden">
      <div class="max-w-7xl mx-auto">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">Survey Analytics</h2>
          <p class="text-gray-600">Real-time insights from student feedback</p>
        </div>

        <!-- Stats Cards -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center">
            <iframe title="Python Support Statistics BACKUP" width="1140" height="541.25" src="https://app.powerbi.com/reportEmbed?reportId=c477ad7d-6b44-46ad-9c62-c9b66d6ac02b&autoAuth=true&ctid=f251f123-c9ce-448e-9277-34bb285911d9" frameborder="0" allowFullScreen="true"></iframe>
          </div>
        </div>
      </div>  
    </div>
  </div>

  <!-- Modals -->
  <div id="thankYouModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-xs mx-auto">
      <h2 class="text-xl font-semibold mb-2">We value your time</h2>
      <p class="mb-4">Thank you for your feedback!</p>
      <button id="closeModal" class="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
        Close
      </button>
    </div>
  </div>
  
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-xs mx-auto">
      <div class="flex justify-center mb-3">
        <svg class="w-16 h-16 text-red-600" fill="currentColor" stroke="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
      </div>
      <h2 class="text-xl font-semibold mb-2 text-gray-800">Error</h2>
      <p class="error-message mb-4 text-gray-600">An error occurred.</p>
      <button id="closeErrorModal" class="mt-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
        OK
      </button>
    </div>
  </div>

  <script type="module">
    // Logic App endpoint
    const endpoint = "https://python-support-proxy.azurewebsites.net/api/surveyProxy";

    let selectedBuilding = null;

    // Page elements
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const openSidebarBtn = document.getElementById('openSidebar');
    const closeSidebarBtn = document.getElementById('closeSidebar');
    const surveyTab = document.getElementById('surveyTab');
    const analyticsTab = document.getElementById('analyticsTab');
    const buildingSelectionPage = document.getElementById('buildingSelectionPage');
    const surveyPage = document.getElementById('surveyPage');
    const analyticsPage = document.getElementById('analyticsPage');
    const pageTitle = document.getElementById('pageTitle');
    //const selectedBuildingText = document.getElementById('selectedBuildingText');

    // Building selection functions
    function selectBuilding(buildingNumber) {
      selectedBuilding = buildingNumber;
      //selectedBuildingText.textContent = `Building ${buildingNumber}`;
      showSurveyForm();
    }

    function selectCustomBuilding() {
      const customInput = document.getElementById('customBuilding');
      const buildingNumber = parseInt(customInput.value);
      
      if (!customInput.value || isNaN(buildingNumber) || buildingNumber <= 100 || buildingNumber >= 500) {
        showError('Please enter a valid building number (101-499).');
        return;
      }
      
      selectBuilding(buildingNumber);
    }

    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        selectCustomBuilding();
      }
    }

    function showBuildingSelection() {
      buildingSelectionPage.classList.remove('hidden');
      surveyPage.classList.add('hidden');
      analyticsPage.classList.add('hidden');
      pageTitle.textContent = 'Select Building';
    }

    function showSurveyForm() {
      buildingSelectionPage.classList.add('hidden');
      surveyPage.classList.remove('hidden');
      analyticsPage.classList.add('hidden');
      pageTitle.textContent = 'Student Satisfaction Survey';
    }

    // Make functions global for onclick handlers
    window.selectBuilding = selectBuilding;
    window.selectCustomBuilding = selectCustomBuilding;
    window.handleEnterKey = handleEnterKey;
    window.showBuildingSelection = showBuildingSelection;

    // Sidebar functionality
    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebarOverlay.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      sidebarOverlay.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    openSidebarBtn.addEventListener('click', openSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);

    // Page navigation
    function switchToSurvey() {
      if (selectedBuilding === null) {
        showBuildingSelection();
      } else {
        showSurveyForm();
      }
      
      surveyTab.classList.add('border-r-4', 'border-red-500', 'bg-gray-50');
      analyticsTab.classList.remove('border-r-4', 'border-red-500', 'bg-gray-50');
      closeSidebar();
    }

    function switchToAnalytics() {
      buildingSelectionPage.classList.add('hidden');
      surveyPage.classList.add('hidden');
      analyticsPage.classList.remove('hidden');
      analyticsTab.classList.add('border-r-4', 'border-red-500', 'bg-gray-50');
      surveyTab.classList.remove('border-r-4', 'border-red-500', 'bg-gray-50');
      pageTitle.textContent = 'Survey Analytics';
      closeSidebar();
    }

    surveyTab.addEventListener('click', (e) => {
      e.preventDefault();
      switchToSurvey();
    });

    analyticsTab.addEventListener('click', (e) => {
      e.preventDefault();
      switchToAnalytics();
    });

    // Error handling
    function showError(message) {
      document.querySelector('.error-message').textContent = message;
      document.getElementById('errorModal').classList.remove('hidden');
    }

    // CSV autocomplete loader
    (async () => {
      try {
        const res = await fetch('./courses.csv');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const csv = await res.text();
        const lines = csv.split('\n');
        const records = [];
        let buffer = '';
        let inQuotes = false;
        lines.forEach(line => {
          const quoteCount = (line.match(/"/g) || []).length;
          if (!inQuotes) {
            buffer = line;
            if (quoteCount % 2 !== 0) {
              inQuotes = true;
            } else {
              records.push(buffer);
            }
          } else {
            buffer += '\n' + line;
            if (quoteCount % 2 !== 0) {
              inQuotes = false;
              records.push(buffer);
            }
          }
        });
        records.shift();
        const dl = document.getElementById('courses');
        records.forEach(record => {
          const idx = record.indexOf(',');
          const code = record.slice(0, idx).trim();
          let rawName = record.slice(idx + 1);
          rawName = rawName
            .replace(/\r/g, '')
            .replace(/CR$/, '')
            .replace(/^"+|"+$/g, '')
            .trim();
          const opt = document.createElement('option');
          opt.value = `${code} - ${rawName}`;
          dl.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading courses.csv:', err);
      }
    })();

    // Form handling
    const form = document.getElementById("surveyForm");
    const thankYouModal = document.getElementById("thankYouModal");
    const errorModal = document.getElementById("errorModal");
    const closeBtn = document.getElementById("closeModal");
    const closeErrorBtn = document.getElementById("closeErrorModal");
    const submitButton = document.getElementById("submitButton");

    form.addEventListener("submit", async (e) => { 
      e.preventDefault();
      
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      submitButton.classList.add('opacity-50', 'cursor-not-allowed');
      
      const payload = {
        student_number: 's' + form.student_number.value.trim(),
        satisfaction: Number(
          form.querySelector('input[name="satisfaction"]:checked').value
        ),
        course_number: form.course_number.value.trim() || null,
        building_Number: selectedBuilding,
      };

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload)
        });
        
        if (response.ok) {
          thankYouModal.classList.remove('hidden'); 
          form.reset();
          document.activeElement?.blur();
          setTimeout(() => {
            thankYouModal.classList.add('hidden');
          }, 3000); 
        } else {
          const errorData = await response.json(); 
          errorModal.querySelector('.error-message').textContent = errorData.message || "An error occurred while submitting your response.";
          errorModal.classList.remove('hidden');

          if (!errorData.exists) {
            form.student_number.value = '';
          }
        }
      } catch (err) {
        console.error("Background submit failed:", err);
        errorModal.classList.remove('hidden');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Survey';
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    });

    closeBtn.addEventListener('click', () => {
      thankYouModal.classList.add('hidden');
    });

    closeErrorBtn.addEventListener('click', () => {
      errorModal.classList.add('hidden');
    });

    // Initialize with building selection
    showBuildingSelection();
  </script>
</body>
</html>